<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>iNaiHR: JANUS NEXUS</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Orbitron:wght@600;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --bg-dark: #05000a; --c-primary: #d300ff; --c-accent: #00e5ff; --c-white: #e0ccff; --c-red: #ff2a6d; --glass-border: rgba(211, 0, 255, 0.25); }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: var(--bg-dark); font-family: 'Rajdhani', sans-serif; color: var(--c-white); user-select: none; }
        #neural-bg { position: absolute; width: 100%; height: 100%; background: radial-gradient(circle at 50% 50%, #120024, #000); z-index: 0; pointer-events: none; }
        #logo { position: absolute; top: 30px; left: 30px; z-index: 10; font-family: 'Orbitron'; font-size: 1.6rem; color: rgba(255,255,255,0.2); pointer-events: none; }
        #logo span.i { color: var(--c-accent); } #logo span.ai { color: var(--c-primary); }
        .ui-group { position: absolute; top: 40px; right: 30px; z-index: 10; display: flex; gap: 10px; }
        .ui-btn { background: rgba(20, 0, 40, 0.6); border: 1px solid var(--glass-border); color: var(--c-primary); padding: 8px 16px; font-family: 'Orbitron'; font-weight: 700; font-size: 0.75rem; cursor: pointer; }
        #btn-synth.active { background: var(--c-accent); color: #000; }
        #main-btn { position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%); width: 72px; height: 72px; z-index: 100; border-radius: 50%; background: radial-gradient(circle, #2a003b, #000); border: 1px solid var(--c-primary); display: flex; justify-content: center; align-items: center; cursor: pointer; transition: 0.3s; }
        #main-btn::after { content: '+'; font-size: 30px; color: var(--c-primary); }
        #main-btn.mode-edit::after { content: 'âœŽ'; color: white; }
        .modal-backdrop { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:200; display:none; justify-content:center; align-items:center; }
        .modal-content { background:#0a0014; border:1px solid var(--c-primary); padding:20px; text-align:center; width:80%; max-width:300px; }
        input { background:transparent; border:none; border-bottom:2px solid var(--c-primary); color:white; font-size:1.2rem; text-align:center; width:100%; outline:none; margin-bottom:20px; }
        .modal-btn { width:100%; padding:10px; background:var(--c-primary); border:none; font-weight:bold; cursor:pointer; }
        #alert-msg { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); color:var(--c-accent); font-family:'Orbitron'; font-size:1.5rem; opacity:0; pointer-events:none; transition:0.3s; z-index:300; text-shadow:0 0 20px var(--c-accent); text-align: center; width: 100%; }
        
        .link { stroke: rgba(211, 0, 255, 0.2); stroke-width: 1.5px; }
        .neuron-core { fill: #000; stroke: var(--c-primary); stroke-width: 2px; }
        .neuron-aura { fill: transparent; stroke: #9d00ff; stroke-width: 1px; opacity: 0.3; }
        .node-group.selected .neuron-core { stroke: var(--c-accent); filter: drop-shadow(0 0 10px var(--c-accent)); }
        .node-group.selected text { fill: var(--c-accent); }
        text { font-family: 'Orbitron'; font-size: 10px; fill: rgba(255,255,255,0.6); pointer-events: none; text-anchor: middle; }
    </style>
</head>
<body>
    <div id="neural-bg"></div>
    <div id="logo"><span class="i">i</span>N<span class="ai">ai</span>HR</div>
    <div class="ui-group"><button id="btn-synth" class="ui-btn" onclick="synthAI()">AI SYNTH</button><button class="ui-btn" onclick="clearData()">WIPE</button></div>
    <div id="alert-msg"></div>
    <button id="main-btn" class="mode-add"></button>
    <div id="rename-modal" class="modal-backdrop"><div class="modal-content"><input type="text" id="rename-input"><button class="modal-btn" onclick="saveRename()">OK</button></div></div>
    <div id="chart"></div>

<script>
    // === CONFIGURATION ===
    const NGROK_URL = "https://supperless-yoshiko-noneruditely.ngrok-free.dev"; 
    const API_ENDPOINT = `${NGROK_URL}/api/inaihr/generate`;
    
    // Headers to bypass Ngrok warning page
    const API_HEADERS = { 
        'Content-Type': 'application/json',
        'ngrok-skip-browser-warning': 'true' 
    };

    const width = window.innerWidth, height = window.innerHeight;
    let nodes = [{ id: 1, label: "Origin", x: width/2, y: height/2 }], links = [], selectedNode = null;
    
    const saved = localStorage.getItem('inaihr_ngrok_v2');
    if(saved) { const d = JSON.parse(saved); nodes=d.nodes; links=d.links; }

    const svg = d3.select("#chart").append("svg").attr("width", width).attr("height", height);
    const g = svg.append("g");
    const linkG = g.append("g"), nodeG = g.append("g");
    
    svg.call(d3.zoom().on("zoom", e => g.attr("transform", e.transform))).on("dblclick.zoom", null);
    svg.on("click", e => { if(e.target.tagName==='svg') deselect(); });

    const sim = d3.forceSimulation(nodes)
        .force("link", d3.forceLink(links).id(d=>d.id).distance(120))
        .force("charge", d3.forceManyBody().strength(-400))
        .force("collide", d3.forceCollide(40))
        .force("center", d3.forceCenter(width/2, height/2))
        .on("tick", render);

    async function synthAI() {
        if(!selectedNode) return alertMsg("SELECT NODE");
        const btn = document.getElementById('btn-synth');
        btn.innerText = "UPLOADING..."; btn.disabled = true;

        const prompt = `Node: "${selectedNode.label}". Generate 4 children (JSON: [{"text":"...", "emoji":"..."}]).`;

        try {
            const res = await fetch(API_ENDPOINT, {
                method: 'POST',
                headers: API_HEADERS,
                body: JSON.stringify({ prompt: prompt })
            });

            if(!res.ok) throw new Error("Connection Failed");
            const data = await res.json();
            
            if(!Array.isArray(data)) throw new Error("Bad Data");

            data.forEach((item, i) => {
                const nn = { id: Date.now()+i, label: `${item.emoji||'ðŸ”¹'} ${item.text}`, x: selectedNode.x, y: selectedNode.y, isAI: true };
                nodes.push(nn); links.push({ source: selectedNode.id, target: nn.id });
            });
            
            update(); alertMsg(`RECEIVED ${data.length} NODES`);
        } catch(e) {
            console.error(e); alertMsg("JANUS UNREACHABLE");
        } finally {
            btn.innerText = "AI SYNTH"; btn.disabled = false;
        }
    }

    const btnMain = document.getElementById('main-btn');
    btnMain.onclick = () => { if(selectedNode) openModal(); else createNode(); };
    
    function createNode() {
        const nn = { id: Date.now(), label: "Void", x: width/2, y: height/2 };
        nodes.push(nn); selectedNode = nn; update(); openModal();
    }
    
    function nodeClick(e, d) {
        e.stopPropagation();
        if(selectedNode && selectedNode !== d) {
            if(!links.find(l => (l.source.id===selectedNode.id && l.target.id===d.id))) {
                links.push({source:selectedNode.id, target:d.id});
            }
            selectedNode = d;
        } else {
            selectedNode = d;
        }
        update();
    }

    function deselect() { selectedNode = null; update(); }
    function openModal() { 
        document.getElementById('rename-modal').style.display='flex'; 
        const inp = document.getElementById('rename-input');
        inp.value = selectedNode.label; inp.focus();
    }
    function saveRename() {
        if(selectedNode) selectedNode.label = document.getElementById('rename-input').value;
        document.getElementById('rename-modal').style.display='none'; update();
    }
    function clearData() { localStorage.removeItem('inaihr_ngrok_v2'); location.reload(); }
    
    function alertMsg(txt) {
        const el = document.getElementById('alert-msg');
        el.innerText = txt; el.style.opacity=1;
        setTimeout(()=>el.style.opacity=0, 2000);
    }

    function update() {
        sim.nodes(nodes); sim.force("link").links(links); sim.alpha(1).restart();
        localStorage.setItem('inaihr_ngrok_v2', JSON.stringify({nodes:nodes.map(n=>({id:n.id, label:n.label, x:n.x, y:n.y})), links:links.map(l=>({source:l.source.id, target:l.target.id}))}));
        
        const btnSynth = document.getElementById('btn-synth');
        if(selectedNode) { btnMain.classList.add('mode-edit'); btnSynth.classList.add('active'); }
        else { btnMain.classList.remove('mode-edit'); btnSynth.classList.remove('active'); }
        render();
    }

    function render() {
        let l = linkG.selectAll("line").data(links);
        l.enter().append("line").attr("class", "link").merge(l)
            .attr("x1", d=>d.source.x).attr("y1", d=>d.source.y).attr("x2", d=>d.target.x).attr("y2", d=>d.target.y);
        l.exit().remove();

        let n = nodeG.selectAll("g").data(nodes, d=>d.id);
        const enter = n.enter().append("g").call(d3.drag().on("start", dragstart).on("drag", dragged).on("end", dragend)).on("click", nodeClick);
        enter.append("circle").attr("class", "neuron-aura").attr("r", 35);
        enter.append("circle").attr("class", "neuron-core").attr("r", 10);
        enter.append("text").attr("dy", 25);
        
        const all = enter.merge(n);
        all.attr("transform", d=>`translate(${d.x},${d.y})`)
           .attr("class", d=>`node-group ${d===selectedNode?'selected':''}`);
        all.select("text").text(d=>d.label);
        n.exit().remove();
    }

    function dragstart(e,d) { if(!e.active) sim.alphaTarget(0.3).restart(); d.fx=d.x; d.fy=d.y; }
    function dragged(e,d) { d.fx=e.x; d.fy=e.y; }
    function dragend(e,d) { if(!e.active) sim.alphaTarget(0); d.fx=null; d.fy=null; update(); }

    update();
</script>
</body>
</html>
