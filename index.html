// --- –ú–û–î–£–õ–¨ –ó–ê–ì–†–£–ó–ö–ò –ò –û–ë–™–ï–î–ò–ù–ï–ù–ò–Ø –î–ê–ù–ù–´–• (Loader) ---

const REGISTRY_FILES = [
  { version: 'v5.2', file: 'janus-meta-registry-v5.2.json', url: 'https://raw.githubusercontent.com/Hawkar-usls/janus-meta-registry/main/janus-meta-registry-v5.2.json' },
  { version: 'v5.4', file: 'janus-meta-registry-v5.4.json', url: '...' },
  { version: 'v5.5', file: 'janus-meta-registry-v5.5.json', url: '...' },
  { version: 'v5.6', file: 'janus-meta-registry-v5.6.json', url: '...' },
  { version: 'v5.7', file: 'janus-meta-registry-v5.7.json', url: '...' },
  { version: 'v5.8', file: 'janus-meta-registry-v5.8.json', url: '...' },
  { version: 'v5.9', file: 'janus-ai-integration-v5.9.json', url: '...' },
  { version: 'v6.3', file: 'janus-meta-registry-v6.3.json', url: '...' },
  { version: 'v7.2', file: 'janus-human-sync-neuro-v7.2.json', url: '...' },
  { version: 'v7.3', file: 'janus-human-sync-global-v7.3.json', url: '...' },
  // ... –¥–æ–±–∞–≤–∏—à—å —Å—é–¥–∞ v8.3 –∏ –¥—Ä—É–≥–∏–µ
];

// –•—Ä–∞–Ω–∏–ª–∏—â–µ –æ–±—ä–µ–¥–∏–Ω—ë–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
let masterNodeMap = new Map(); // –ö–ª—é—á: —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID (event_id –∏–ª–∏ –∏–º—è —Å—É—â–Ω–æ—Å—Ç–∏)
let masterLinks = [];

async function loadAllRegistries(progressCallback) {
  masterNodeMap.clear();
  masterLinks = [];
  
  for (let i = 0; i < REGISTRY_FILES.length; i++) {
    const reg = REGISTRY_FILES[i];
    try {
      const response = await fetch(reg.url);
      const data = await response.json();
      mergeRegistry(data, reg.version);
      if (progressCallback) progressCallback(i + 1, REGISTRY_FILES.length);
    } catch (e) {
      console.error(`Failed to load ${reg.file}:`, e);
    }
  }
  
  // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º Map –≤ –º–∞—Å—Å–∏–≤ –¥–ª—è D3
  return {
    nodes: Array.from(masterNodeMap.values()),
    links: masterLinks
  };
}

function mergeRegistry(data, versionTag) {
  // --- –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —É–∑–ª–æ–≤ –∏–∑ empirical_layer ---
  if (data.collections) {
    // –î–ª—è —Å—Ç–∞—Ä—ã—Ö –≤–µ—Ä—Å–∏–π (v5.x) —Å "collections"
    Object.values(data.collections).forEach(collection => {
      if (collection.sites) {
        collection.sites.forEach(site => {
          const nodeId = site.id || `${versionTag}-${site.name}-${Date.now()}`;
          if (!masterNodeMap.has(nodeId)) {
            masterNodeMap.set(nodeId, {
              id: nodeId,
              label: site.name,
              type: site.content_matrix?.dominant_subjects?.[0]?.toLowerCase() || 'default',
              emoji: getEmojiForType(site.content_matrix?.dominant_subjects?.[0]),
              version: versionTag,
              layer: 'empirical',
              // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Å–ø–ª—ã–≤–∞—é—â–∏—Ö –ø–æ–¥—Å–∫–∞–∑–æ–∫
              sourceData: site
            });
          }
        });
      }
    });
  }
  
  // –î–ª—è –Ω–æ–≤—ã—Ö –≤–µ—Ä—Å–∏–π (v6.3+) —Å empirical_layer
  if (data.empirical_layer) {
    data.empirical_layer.forEach(item => {
      const nodeId = item.event_id;
      if (!masterNodeMap.has(nodeId)) {
        masterNodeMap.set(nodeId, {
          id: nodeId,
          label: item.name || item.event_id,
          type: item.verification_status === 'confirmed_official' ? 'info' : 
                (item.verification_status === 'confirmed_military' ? 'warn' : 'default'),
          emoji: getEmojiForEvent(item),
          version: versionTag,
          layer: 'empirical',
          sourceData: item
        });
      }
    });
  }

  // --- –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —É–∑–ª–æ–≤ –∏–∑ hypothesis_layer (–¥–ª—è –Ω–æ–≤—ã—Ö –≤–µ—Ä—Å–∏–π) ---
  if (data.hypothesis_layer) {
    data.hypothesis_layer.forEach(hyp => {
      // –ö–∞–∂–¥–∞—è –≥–∏–ø–æ—Ç–µ–∑–∞ –º–æ–∂–µ—Ç —Å—Ç–∞—Ç—å —É–∑–ª–æ–º
      const nodeId = hyp.event_id;
      if (!masterNodeMap.has(nodeId)) {
        masterNodeMap.set(nodeId, {
          id: nodeId,
          label: hyp.description?.substring(0, 50) + '...' || hyp.event_id,
          type: 'info',
          emoji: 'üß†',
          version: versionTag,
          layer: 'hypothesis',
          sourceData: hyp
        });
      }
      
      // –î–æ–±–∞–≤–ª—è–µ–º —Å–≤—è–∑–∏ –º–µ–∂–¥—É –≥–∏–ø–æ—Ç–µ–∑–æ–π –∏ —ç–º–ø–∏—Ä–∏—á–µ—Å–∫–∏–º–∏ –∫–µ–π—Å–∞–º–∏, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
      if (hyp.connections_to_other_registries) {
        hyp.connections_to_other_registries.forEach(conn => {
          masterLinks.push({
            source: nodeId,
            target: conn, // ID —Ü–µ–ª–µ–≤–æ–≥–æ —É–∑–ª–∞ (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ masterNodeMap)
            type: 'hypothesis'
          });
        });
      }
    });
  }

  // --- –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å–≤—è–∑–µ–π –∏–∑ correlation_analysis (–¥–ª—è –Ω–æ–≤—ã—Ö –≤–µ—Ä—Å–∏–π) ---
  if (data.correlation_analysis && data.correlation_analysis.matrix) {
    data.correlation_analysis.matrix.forEach(corr => {
      masterLinks.push({
        source: corr.source_id,
        target: corr.target_id,
        type: corr.type || 'correlation',
        strength: corr.strength || 0.5
      });
    });
  }

  // --- –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å–≤—è–∑–µ–π –∏–∑ meta_links (–¥–ª—è —Å—Ç–∞—Ä—ã—Ö –≤–µ—Ä—Å–∏–π) ---
  if (data.meta_links) {
    Object.values(data.meta_links).forEach(linkArray => {
      linkArray.forEach(link => {
        masterLinks.push({
          source: link.source,
          target: link.target,
          type: 'meta'
        });
      });
    });
  }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–±–æ—Ä–∞ —ç–º–æ–¥–∑–∏
function getEmojiForEvent(item) {
  if (item.event_type?.includes('military')) return '‚öîÔ∏è';
  if (item.event_type?.includes('medical')) return 'üè•';
  if (item.event_type?.includes('volcanic')) return 'üåã';
  if (item.event_type?.includes('neural')) return 'üß†';
  return 'üìÑ';
}

function getEmojiForType(type) {
  if (type?.toLowerCase().includes('uap')) return 'üõ∏';
  if (type?.toLowerCase().includes('nuclear')) return '‚ò¢Ô∏è';
  return 'üîπ';
}
