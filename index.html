<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>iNaiHR: JANUS LINK</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* BASE PALETTE */
            --bg-deep: #051a24;
            --c-cell: #a3e635;    /* Default Green */
            --glass: rgba(255, 255, 255, 0.1);
            
            /* JANUS CATEGORY COLORS */
            --cat-game: #a855f7;  /* Purple for Games */
            --cat-ai: #f472b6;    /* Pink for AI */
            --cat-tech: #3b82f6;  /* Blue for Tech/Code */
            --cat-def: #a3e635;   /* Green for Organic */
        }

        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            background: radial-gradient(circle at center, #134e4a 0%, #020617 100%); 
            overflow: hidden; font-family: 'Comfortaa', cursive; color: #fff; user-select: none; 
        }
        
        /* BACKGROUND SOUP */
        #soup {
            position: absolute; width: 100%; height: 100%; pointer-events: none; z-index: 0; opacity: 0.3;
            background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIj48Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSIyIiBmaWxsPSIjZmZmIiBvcGFjaXR5PSIwLjIiLz48L3N2Zz4=');
            animation: drift 60s linear infinite;
        }
        @keyframes drift { from { background-position: 0 0; } to { background-position: 100px 100px; } }

        /* UI LAYER */
        #ui-layer { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; 
            display: flex; flex-direction: column; justify-content: space-between; padding: 20px; 
        }
        
        .header { display: flex; align-items: center; gap: 10px; pointer-events: auto; }
        .logo { font-weight: 700; font-size: 20px; text-shadow: 0 0 10px var(--c-cell); color: #fff; }
        .status-dot { width: 10px; height: 10px; background: #555; border-radius: 50%; box-shadow: 0 0 5px #000; transition: 0.3s; }
        .status-dot.active { background: var(--c-cell); box-shadow: 0 0 10px var(--c-cell); }
        .status-dot.error { background: #ef4444; box-shadow: 0 0 10px #ef4444; }

        .controls { display: flex; justify-content: center; gap: 20px; pointer-events: auto; padding-bottom: 30px; }
        .fab { 
            width: 60px; height: 60px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.2); 
            background: rgba(255,255,255,0.1); backdrop-filter: blur(5px); color: #fff; font-size: 24px; 
            cursor: pointer; transition: 0.2s; display: flex; justify-content: center; align-items: center; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .fab:hover { transform: scale(1.1); background: rgba(255,255,255,0.2); border-color: var(--c-cell); }

        /* MODAL */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); 
            backdrop-filter: blur(8px); z-index: 100; display: none; justify-content: center; align-items: center; 
        }
        .modal-overlay.active { display: flex; }
        
        .blob-card { 
            width: 300px; padding: 30px; background: rgba(20, 40, 35, 0.9); border-radius: 40px 10px 40px 10px; 
            border: 2px solid var(--c-cell); box-shadow: 0 0 30px rgba(163, 230, 53, 0.2); text-align: center; 
        }
        .blob-card input { 
            width: 100%; padding: 12px; border-radius: 20px; border: none; background: rgba(0,0,0,0.3); 
            color: #fff; font-family: inherit; margin-bottom: 20px; outline: none; text-align: center; font-size: 1.2rem;
        }
        .btn { padding: 10px 20px; border-radius: 20px; border: none; font-weight: 700; cursor: pointer; margin: 5px; }
        .btn-save { background: var(--c-cell); color: #002; }
        .btn-close { background: transparent; color: #aaa; border: 1px solid #aaa; }

        /* GRAPH */
        #chart { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        .link { stroke: rgba(255, 255, 255, 0.15); stroke-width: 2px; stroke-linecap: round; }
        
        .node circle.membrane { fill: rgba(255,255,255,0.05); stroke: rgba(255,255,255,0.3); stroke-width: 1.5px; transition: all 0.3s; }
        .node circle.core { fill: var(--c-cell); transition: all 0.5s; }
        
        /* CATEGORY STYLES (Dynamic from Janus) */
        .node.game circle.core { fill: var(--cat-game); stroke: var(--cat-game); }
        .node.ai circle.core { fill: var(--cat-ai); stroke: var(--cat-ai); }
        .node.tech circle.core { fill: var(--cat-tech); stroke: var(--cat-tech); }
        .node.default circle.core { fill: var(--cat-def); stroke: var(--cat-def); }

        .node:hover circle.membrane { r: 35; stroke: #fff; opacity: 0.5; }
        .node:hover circle.core { r: 12; filter: drop-shadow(0 0 5px #fff); }

        .node text { 
            font-size: 12px; fill: #fff; pointer-events: none; text-shadow: 0 2px 4px #000; 
            font-weight: 700; text-anchor: middle; transition: 0.3s;
        }
        .node text.emoji { font-size: 20px; filter: drop-shadow(0 0 10px rgba(0,0,0,0.5)); }

        /* Animations */
        @keyframes pulse { 0% { r: 8; } 50% { r: 10; } 100% { r: 8; } }
        .node circle.core { animation: pulse 4s infinite ease-in-out; animation-delay: var(--delay); }
        
        .node.loading circle.core { fill: #fff; animation: spin 1s infinite linear; }
        @keyframes spin { 0% { opacity: 0.5; r: 5; } 50% { opacity: 1; r: 8; } 100% { opacity: 0.5; r: 5; } }

    </style>
</head>
<body>

    <div id="soup"></div>
    <div id="chart"></div>

    <div id="ui-layer">
        <div class="header">
            <div class="status-dot" id="status-ind"></div>
            <div class="logo">iNaiHR: Janus</div>
        </div>
        
        <div class="controls">
            <button class="fab" onclick="openAddModal()">+</button>
            <button class="fab" onclick="resetZoom()" style="font-size:16px">‚åñ</button>
        </div>
    </div>

    <div class="modal-overlay" id="modal">
        <div class="blob-card">
            <h2 id="m-title">Add Node</h2>
            <input type="text" id="node-input" placeholder="Concept..." maxlength="25" autocomplete="off">
            <div class="actions">
                <button class="btn btn-close" onclick="closeModal()">Close</button>
                <button class="btn btn-save" onclick="saveNode()">Synth</button>
            </div>
        </div>
    </div>

<script>
    // === SETTINGS ===
    // –£–∫–∞–∂–∏—Ç–µ –∑–¥–µ—Å—å URL –≤–∞—à–µ–≥–æ Python —Å–µ—Ä–≤–µ—Ä–∞ (ngrok –∏–ª–∏ IP NAS)
    // –í–∞–∂–Ω–æ: –¥–æ–ª–∂–µ–Ω –∑–∞–∫–∞–Ω—á–∏–≤–∞—Ç—å—Å—è –Ω–∞ /api/janus/process
    const API_URL = "https://supperless-yoshiko-noneruditely.ngrok-free.dev/api/janus/process"; 
    
    // === STATE ===
    let nodes = [];
    let links = [];
    
    // Initial Data
    nodes = [{id: 1, label: "Core", emoji: "üí†", category: "default", x: 0, y: 0}];

    let simulation, svg, g, linkG, nodeG;
    let editModeNode = null;

    window.onload = () => {
        initGraph();
        updateGraph();
    };

    function initGraph() {
        const width = window.innerWidth, height = window.innerHeight;
        svg = d3.select("#chart").append("svg")
            .attr("width", width).attr("height", height)
            .on("click", (e) => { if(e.target.tagName === 'svg') closeModal(); });

        g = svg.append("g");
        linkG = g.append("g");
        nodeG = g.append("g");

        const zoom = d3.zoom().scaleExtent([0.1, 4]).on("zoom", (e) => g.attr("transform", e.transform));
        svg.call(zoom);
        svg.call(zoom.transform, d3.zoomIdentity.translate(width/2, height/2));

        simulation = d3.forceSimulation()
            .force("link", d3.forceLink().id(d => d.id).distance(140))
            .force("charge", d3.forceManyBody().strength(-400))
            .force("center", d3.forceCenter(width / 2, height / 2))
            .force("collide", d3.forceCollide(50).strength(0.8))
            .on("tick", ticked);
    }

    // === MAIN LOGIC ===

    async function saveNode() {
        const input = document.getElementById('node-input');
        const txt = input.value.trim();
        if (!txt) return;

        let targetNode;
        
        if (editModeNode) {
            editModeNode.label = txt;
            editModeNode.emoji = "‚è≥";
            editModeNode.loading = true;
            targetNode = editModeNode;
        } else {
            // Optimistic Creation
            targetNode = {
                id: Date.now(),
                label: txt,
                emoji: "‚è≥",
                category: "default",
                x: window.innerWidth/2 + (Math.random()-0.5)*20,
                y: window.innerHeight/2 + (Math.random()-0.5)*20,
                loading: true
            };
            nodes.push(targetNode);
        }

        closeModal();
        input.value = "";
        updateGraph();
        
        // Call Janus
        await callJanus(targetNode);
    }

    async function callJanus(node) {
        const statusInd = document.getElementById('status-ind');
        statusInd.className = "status-dot active"; // Show activity

        try {
            // 1. Prepare Context (exclude self)
            const contextData = nodes
                .filter(n => n.id !== node.id)
                .map(n => ({ id: n.id, label: n.label }));

            // 2. Fetch
            const res = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    target_node: node.label,
                    context: contextData
                })
            });

            if (!res.ok) throw new Error("Janus Offline");

            const data = await res.json();

            // 3. Apply AI Data
            node.emoji = data.emoji || "üì¶";
            node.category = data.category || "default";
            node.loading = false;

            // 4. Auto-Linking
            let newLinks = 0;
            if (data.link_to_ids && Array.isArray(data.link_to_ids)) {
                data.link_to_ids.forEach(targetId => {
                    const exists = links.some(l => 
                        (l.source.id === node.id && l.target.id === targetId) ||
                        (l.source.id === targetId && l.target.id === node.id)
                    );
                    
                    const targetObj = nodes.find(n => n.id === targetId);
                    
                    if (!exists && targetObj) {
                        links.push({ source: node.id, target: targetObj.id });
                        newLinks++;
                    }
                });
            }
            
            console.log(`Janus: Classified as [${node.category}], created ${newLinks} links.`);
            statusInd.className = "status-dot"; // Reset status

        } catch (e) {
            console.error("AI Error:", e);
            node.emoji = "‚ö†Ô∏è";
            node.loading = false;
            statusInd.className = "status-dot error";
        }
        
        updateGraph();
    }

    // === D3 RENDER ===

    function updateGraph() {
        // NODES
        let nodeSel = nodeG.selectAll(".node").data(nodes, d => d.id);
        
        const nodeEnter = nodeSel.enter().append("g")
            .attr("class", "node")
            .call(d3.drag().on("start", dragstart).on("drag", dragged).on("end", dragend))
            .on("dblclick", (e, d) => { editModeNode = d; openAddModal(); });

        nodeEnter.append("circle").attr("class", "membrane").attr("r", 28);
        nodeEnter.append("circle").attr("class", "core").attr("r", 8).style("--delay", d => Math.random()+"s");
        
        nodeEnter.append("text").attr("class", "emoji").attr("dy", -12).text(d => d.emoji);
        nodeEnter.append("text").attr("class", "label").attr("dy", 32).text(d => d.label);

        nodeSel.exit().remove();

        const allNodes = nodeEnter.merge(nodeSel);
        
        // Update Dynamic Classes & Text
        allNodes.attr("class", d => `node ${d.loading ? 'loading' : ''} ${d.category || 'default'}`);
        allNodes.select(".emoji").text(d => d.emoji);
        allNodes.select(".label").text(d => d.label);

        // LINKS
        let linkSel = linkG.selectAll(".link").data(links, d => (d.source.id||d.source)+"-"+(d.target.id||d.target));
        linkSel.exit().remove();
        linkSel.enter().append("line").attr("class", "link").merge(linkSel);

        simulation.nodes(nodes);
        simulation.force("link").links(links);
        simulation.alpha(0.8).restart();
    }

    function ticked() {
        linkG.selectAll(".link")
            .attr("x1", d => d.source.x).attr("y1", d => d.source.y)
            .attr("x2", d => d.target.x).attr("y2", d => d.target.y);
        nodeG.selectAll(".node").attr("transform", d => `translate(${d.x},${d.y})`);
    }

    // === UI UTILS ===
    function openAddModal() {
        const inp = document.getElementById('node-input');
        document.getElementById('m-title').innerText = editModeNode ? "Edit Node" : "Add Node";
        inp.value = editModeNode ? editModeNode.label : "";
        document.getElementById('modal').classList.add('active');
        setTimeout(() => inp.focus(), 50);
    }
    
    function closeModal() { 
        document.getElementById('modal').classList.remove('active'); 
        editModeNode = null; 
    }
    
    function resetZoom() {
        svg.transition().duration(750).call(
            d3.zoom().transform, 
            d3.zoomIdentity.translate(window.innerWidth/2, window.innerHeight/2).scale(1)
        );
    }

    // Drag Logic
    function dragstart(e, d) { if (!e.active) simulation.alphaTarget(0.3).restart(); d.fx = d.x; d.fy = d.y; }
    function dragged(e, d) { d.fx = e.x; d.fy = e.y; }
    function dragend(e, d) { if (!e.active) simulation.alphaTarget(0); d.fx = null; d.fy = null; }
    
    // Enter key support
    document.getElementById('node-input').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') saveNode();
    });

</script>
</body>
</html>
