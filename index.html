<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#05000a">
    <title>iNaiHR: JANUS NEXUS</title>
    
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Orbitron:wght@600;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-dark: #05000a;
            --bg-pulse: #120024;
            
            /* CYBER PALETTE */
            --c-primary: #d300ff;
            --c-accent: #00e5ff;
            --c-white: #e0ccff;
            --c-red: #ff2a6d;
            
            --neuron-core: var(--c-primary);
            --neuron-aura: #9d00ff;
            --synapse-off: rgba(211, 0, 255, 0.2);
            --grid-line: rgba(211, 0, 255, 0.08);
            --glass-border: rgba(211, 0, 255, 0.25);
        }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; background-color: var(--bg-dark);
            font-family: 'Rajdhani', sans-serif; color: var(--c-white);
            -webkit-user-select: none; user-select: none; touch-action: none;
        }

        /* ATMOSPHERE */
        #neural-bg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at 50% 50%, var(--bg-pulse), var(--bg-dark));
            z-index: 0; animation: pulse-bg 8s infinite alternate ease-in-out; pointer-events: none;
        }
        @keyframes pulse-bg { 0% { opacity: 0.7; transform: scale(1); } 100% { opacity: 1; transform: scale(1.05); } }

        #particles, #grid-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        #particles { z-index: 0; opacity: 0.5; }
        #grid-bg {
            background-image: linear-gradient(var(--grid-line) 1px, transparent 1px), linear-gradient(90deg, var(--grid-line) 1px, transparent 1px);
            background-size: 50px 50px; opacity: 1; z-index: 1;
        }
        .particle { position: absolute; background: var(--c-primary); border-radius: 50%; opacity: 0.6; animation: float 20s infinite linear; box-shadow: 0 0 10px var(--c-primary); }
        @keyframes float { 0% { transform: translateY(0) translateX(0); opacity: 0; } 50% { opacity: 0.8; } 100% { transform: translateY(-100vh) translateX(20px); opacity: 0; } }

        /* UI */
        .ui-element { transition: opacity 0.4s, transform 0.4s; }
        
        #logo {
            position: absolute; top: 30px; left: 30px; z-index: 10;
            font-family: 'Orbitron', sans-serif; font-size: 1.6rem; letter-spacing: 3px;
            color: rgba(255,255,255,0.2); pointer-events: none;
            text-shadow: 0 0 20px rgba(211, 0, 255, 0.2);
        }
        #logo span.i { color: var(--c-accent); }
        #logo span.ai { color: var(--c-primary); text-shadow: 0 0 15px var(--c-primary); }

        /* BUTTONS */
        .ui-group {
            position: absolute; top: 40px; right: 30px; z-index: 10;
            display: flex; gap: 10px;
        }
        .ui-btn {
            background: rgba(20, 0, 40, 0.6); border: 1px solid var(--glass-border);
            color: var(--c-primary); backdrop-filter: blur(12px);
            padding: 8px 16px; border-radius: 4px;
            font-family: 'Orbitron', sans-serif; font-weight: 700; font-size: 0.75rem;
            cursor: pointer; transition: 0.2s; text-transform: uppercase; letter-spacing: 1px;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        .ui-btn:active { transform: scale(0.95); color: white; border-color: white; }
        
        #btn-synth { border-color: var(--c-accent); color: #000; background: var(--c-accent); box-shadow: 0 0 20px rgba(0, 229, 255, 0.4); transition: 0.3s; opacity: 0.3; pointer-events: none; }
        #btn-synth.active { opacity: 1; pointer-events: auto; }
        #btn-synth:disabled { filter: grayscale(1); opacity: 0.5; }
        #btn-synth.loading { animation: pulse-synth 1s infinite; }
        @keyframes pulse-synth { 0% { box-shadow: 0 0 10px var(--c-accent); } 50% { box-shadow: 0 0 30px var(--c-accent); } 100% { box-shadow: 0 0 10px var(--c-accent); } }

        /* MAIN ADD BUTTON */
        #main-btn {
            position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%);
            width: 72px; height: 72px; z-index: 100; border-radius: 50%; border: none;
            background: radial-gradient(circle at 50% 50%, rgba(40, 0, 60, 0.8), rgba(0,0,0,0.9));
            box-shadow: 0 0 0 1px var(--glass-border), 0 0 40px rgba(211, 0, 255, 0.2);
            backdrop-filter: blur(10px); display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.3s; -webkit-tap-highlight-color: transparent;
        }
        #main-btn::after { content: '+'; font-size: 32px; font-weight: 300; color: var(--c-primary); text-shadow: 0 0 10px var(--c-primary); transition: 0.3s; }
        #main-btn:active { transform: translateX(-50%) scale(0.9); }
        
        #main-btn.mode-edit { box-shadow: 0 0 0 2px var(--c-primary), 0 0 50px var(--c-primary); transform: translateX(-50%) rotate(360deg); }
        #main-btn.mode-edit::after { content: 'âœŽ'; color: white; }
        
        #main-btn.holding-delete { background: rgba(60, 0, 20, 0.9); box-shadow: 0 0 0 2px var(--c-red), 0 0 60px var(--c-red); transform: translateX(-50%) scale(1.1); }
        #main-btn.holding-delete::after { content: 'Ã—'; color: var(--c-red); text-shadow: 0 0 15px var(--c-red); }

        /* CHART */
        #chart { position: relative; width: 100%; height: 100%; z-index: 2; }
        .link { fill: none; stroke: var(--synapse-off); stroke-width: 1.5px; transition: stroke 0.3s; }
        .impulse { filter: drop-shadow(0 0 5px var(--c-primary)); pointer-events: none; fill: white; }
        .neuron-core { fill: #0a0014; stroke: var(--c-primary); stroke-width: 2px; filter: drop-shadow(0 0 8px var(--c-primary)); transition: r 0.3s, stroke 0.3s; }
        .neuron-aura { fill: transparent; stroke: var(--neuron-aura); stroke-width: 1px; opacity: 0.3; filter: blur(4px); transition: stroke 0.3s; }
        .hitbox { fill: transparent; cursor: pointer; }
        .node-group.selected .neuron-core { stroke: var(--c-accent); filter: drop-shadow(0 0 15px var(--c-accent)); }
        .node-group.selected .neuron-aura { opacity: 0.6; stroke: var(--c-accent); }
        .node-group.ai-generated .neuron-core { stroke: var(--c-white); } 

        text.label { font-family: 'Orbitron', sans-serif; font-size: 12px; font-weight: 600; letter-spacing: 1px; fill: rgba(224, 204, 255, 0.7); pointer-events: none; text-anchor: middle; text-shadow: 0 2px 5px #000; transition: fill 0.3s; }
        .node-group.selected text.label { fill: var(--c-accent); text-shadow: 0 0 10px rgba(0, 229, 255, 0.5); }

        /* MODALS */
        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); backdrop-filter: blur(10px);
            z-index: 2000; display: none; align-items: center; justify-content: center;
        }
        .modal-content {
            width: 85%; max-width: 320px; padding: 30px; text-align: center;
            background: rgba(20, 0, 30, 0.95); border: 1px solid var(--c-primary); border-radius: 0px;
            box-shadow: 0 0 50px rgba(211, 0, 255, 0.1);
            clip-path: polygon(0 0, 100% 0, 100% 85%, 90% 100%, 0 100%);
        }
        #rename-input {
            width: 100%; background: transparent; border: none; border-bottom: 2px solid var(--c-primary);
            color: var(--c-accent); font-family: 'Orbitron', sans-serif; font-size: 1.4rem;
            text-align: center; padding: 10px; outline: none; margin-bottom: 25px; border-radius: 0;
        }
        .modal-btn {
            width: 100%; padding: 14px; margin-top: 5px; background: rgba(211, 0, 255, 0.1);
            border: 1px solid var(--c-primary); color: var(--c-primary); cursor: pointer;
            font-family: 'Orbitron', sans-serif; font-weight: 700; font-size: 1rem; letter-spacing: 2px;
            transition: 0.2s;
        }
        .modal-btn:active { background: var(--c-primary); color: black; }

        #alert-msg { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: var(--c-accent); font-family: 'Orbitron'; font-size: 1.2rem; text-shadow: 0 0 20px var(--c-accent); pointer-events: none; opacity: 0; transition: opacity 0.5s; z-index: 3000; text-align: center; width: 80%; }
        
        #delete-hint {
            position: absolute; bottom: 130px; 
            left: 50%; transform: translateX(-50%); color: var(--c-red);
            font-size: 0.85rem; letter-spacing: 2px; text-transform: uppercase;
            opacity: 0; transition: 0.3s; pointer-events: none; font-weight: 700;
            text-shadow: 0 0 15px rgba(255, 42, 109, 0.6);
        }
        #delete-hint.visible { opacity: 1; transform: translateX(-50%) translateY(-10px); }

        @media (max-width: 768px) {
            #logo { font-size: 1.2rem; top: 20px; left: 20px; }
            .ui-group { top: 20px; right: 20px; gap: 8px; }
            .ui-btn { padding: 8px 12px; font-size: 0.7rem; }
            #main-btn { width: 64px; height: 64px; }
        }
    </style>
</head>
<body>

    <div id="neural-bg"></div>
    <div id="particles"></div>
    <div id="grid-bg"></div>

    <div id="logo" class="ui-element"><span class="i">i</span>N<span class="ai">ai</span>HR</div>
    
    <div class="ui-group ui-element">
        <button id="btn-synth" class="ui-btn" onclick="synthAI()">AI SYNTH</button>
        <button class="ui-btn" onclick="clearData()">WIPE</button>
    </div>

    <div id="alert-msg"></div>
    <div id="delete-hint">DISCONNECTING...</div>
    
    <button id="main-btn" class="mode-add ui-element"></button>

    <div id="rename-modal" class="modal-backdrop">
        <div class="modal-content">
            <input type="text" id="rename-input" placeholder="INPUT DATA..." autocomplete="off">
            <button class="modal-btn" onclick="saveRename()">INITIATE</button>
        </div>
    </div>

    <div id="confirm-modal" class="modal-backdrop">
        <div class="modal-content">
            <div style="margin-bottom: 20px; font-family: 'Orbitron'; color: var(--c-red); letter-spacing: 1px;">WIPE SYSTEM DATA?</div>
            <div style="display: flex; gap: 10px;">
                <button class="modal-btn" onclick="confirmWipe(true)" style="border-color: var(--c-red); color: var(--c-red);">CONFIRM</button>
                <button class="modal-btn" onclick="confirmWipe(false)">CANCEL</button>
            </div>
        </div>
    </div>

    <div id="chart"></div>

<script>
    // === CONFIGURATION ===
    const API_ENDPOINT = "http://localhost:5000/api/inaihr/generate";
    const isMobile = window.innerWidth < 768;
    const PHYS = { linkDist: isMobile ? 90 : 140, charge: -400, collide: 25 };

    function initParticles() {
        const container = document.getElementById('particles');
        for(let i=0; i<25; i++) {
            const p = document.createElement('div');
            p.className = 'particle';
            p.style.left = Math.random()*100+'%'; p.style.top = Math.random()*100+'%';
            p.style.width = (Math.random()*2+1)+'px'; p.style.height = p.style.width;
            p.style.animationDuration = (Math.random()*5+5)+'s';
            p.style.animationDelay = -(Math.random()*10)+'s';
            container.appendChild(p);
        }
    }
    initParticles();

    function loadData() {
        const saved = localStorage.getItem('inaihr_v2_janus');
        if (saved) { try { return JSON.parse(saved); } catch (e) { return null; } }
        return null;
    }
    const initialData = loadData() || {
        nodes: [ { id: 1, label: "Origin", x: window.innerWidth/2, y: window.innerHeight/2 } ],
        links: []
    };
    let nodes = initialData.nodes;
    let links = initialData.links;

    const width = window.innerWidth, height = window.innerHeight;
    let selectedNode = null; 
    
    const svg = d3.select("#chart").append("svg").attr("width", width).attr("height", height).attr("viewBox", [0, 0, width, height]);
    const g = svg.append("g");
    const linkGroup = g.append("g").attr("class", "links");
    const impulseGroup = g.append("g").attr("class", "impulses");
    const nodeGroup = g.append("g").attr("class", "nodes");

    const zoom = d3.zoom().scaleExtent([0.1, 4]).on("zoom", (event) => g.attr("transform", event.transform));
    svg.call(zoom).call(zoom.transform, d3.zoomIdentity.translate(width/2, height/2).scale(1).translate(-width/2, -height/2));
    
    svg.on("click", (event) => { if (event.target.tagName === 'svg') deselectNode(); });

    const simulation = d3.forceSimulation(nodes)
        .force("link", d3.forceLink(links).id(d => d.id).distance(PHYS.linkDist))
        .force("charge", d3.forceManyBody().strength(PHYS.charge))
        .force("collide", d3.forceCollide().radius(d => (d.radius||40)+10).iterations(2))
        .force("x", d3.forceX(width/2).strength(0.01)) 
        .force("y", d3.forceY(height/2).strength(0.01))
        .alphaDecay(0.03);

    // === AI LOGIC (LINKED TO JANUS CORE) ===
    async function synthAI() {
        if (!selectedNode) { showMsg("SELECT NODE FIRST"); return; }
        
        const btn = document.getElementById('btn-synth');
        btn.disabled = true; btn.classList.add('loading'); btn.innerText = "JANUS LINK...";
        
        // Context for Janus
        const context = `Current Node: "${selectedNode.label}".
        Generate 4 related child concepts.
        IMPORTANT: Assign a relevant EMOJI to every concept.
        
        OUTPUT FORMAT (JSON Array):
        [
            {"text": "Concept1", "emoji": "ðŸ§¬"},
            {"text": "Concept2", "emoji": "ðŸ”®"},
            ...
        ]`;

        try {
            const response = await fetch(API_ENDPOINT, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt: context })
            });
            
            if (!response.ok) throw new Error("Janus Connection Failed");

            const results = await response.json();
            
            // Check validity
            if (!Array.isArray(results)) throw new Error("Invalid Janus Data");

            let angleStep = (Math.PI * 2) / results.length;
            
            results.forEach((item, i) => {
                const angle = (Math.random() * 0.5) + (i * angleStep);
                const dist = 140;
                
                // Combine Emoji + Text
                const labelText = `${item.emoji || 'ðŸ”¹'} ${item.text}`;
                
                const newNode = {
                    id: Date.now() + i,
                    label: labelText,
                    x: selectedNode.x + Math.cos(angle) * dist,
                    y: selectedNode.y + Math.sin(angle) * dist,
                    isAI: true
                };
                
                nodes.push(newNode);
                links.push({ source: selectedNode.id, target: newNode.id });
                setTimeout(() => animateImpulse(selectedNode, newNode), i * 200);
            });

            updateTopology(); simulation.alpha(1).restart(); saveData();
            showMsg(`JANUS GRANTED: ${results.length} NODES`);

        } catch (e) { 
            console.error(e); 
            showMsg("JANUS OFFLINE"); 
        } finally { 
            btn.disabled = false; btn.classList.remove('loading'); btn.innerText = "AI SYNTH"; 
        }
    }

    // === CONTROLS ===
    const mainBtn = document.getElementById('main-btn');
    const deleteHint = document.getElementById('delete-hint');
    let pressTimer, isLongPress = false;

    function handleBtnStart(e) {
        if (e.type === 'touchstart') { e.stopPropagation(); }
        if (selectedNode) {
            isLongPress = false;
            mainBtn.classList.add('holding-delete');
            deleteHint.classList.add('visible');
            if(navigator.vibrate) navigator.vibrate(50);
            pressTimer = setTimeout(() => { 
                isLongPress = true; deleteSelectedNode(); 
                if(navigator.vibrate) navigator.vibrate([50,50]); 
            }, 800);
        } else { mainBtn.style.transform = "translateX(-50%) scale(0.9)"; }
    }
    
    function handleBtnEnd(e) {
        e.preventDefault(); clearTimeout(pressTimer);
        mainBtn.classList.remove('holding-delete'); deleteHint.classList.remove('visible'); 
        mainBtn.style.transform = "";
        if (isLongPress) { isLongPress = false; return; }
        if (selectedNode) openRename(); else createNewNode();
        isLongPress = false;
    }

    mainBtn.addEventListener('mousedown', handleBtnStart); 
    mainBtn.addEventListener('touchstart', handleBtnStart, {passive: false});
    mainBtn.addEventListener('mouseup', handleBtnEnd); 
    mainBtn.addEventListener('touchend', handleBtnEnd);

    function createNewNode() {
        const t = d3.zoomTransform(svg.node());
        const x = (width/2 - t.x)/t.k; const y = (height/2 - t.y)/t.k;
        const newNode = { id: Date.now(), label: "Void", x: x, y: y }; 
        nodes.push(newNode);
        selectedNode = newNode; 
        updateButtonState(); updateTopology(); saveData(); 
        setTimeout(openRename, 50); 
    }

    function deleteSelectedNode() {
        if(!selectedNode) return;
        nodes = nodes.filter(n => n.id !== selectedNode.id);
        links = links.filter(l => l.source.id !== selectedNode.id && l.target.id !== selectedNode.id);
        selectedNode = null; updateButtonState(); updateTopology(); saveData();
    }

    function handleNodeClick(event, d) {
        if (event.defaultPrevented) return;
        if (!selectedNode) { selectedNode = d; }
        else if (selectedNode === d) { selectedNode = null; }
        else {
            const exists = links.some(l => (l.source.id===selectedNode.id && l.target.id===d.id) || (l.source.id===d.id && l.target.id===selectedNode.id));
            if(!exists) { links.push({ source: selectedNode.id, target: d.id }); animateImpulse(selectedNode, d); }
            selectedNode = d; 
        }
        updateButtonState(); updateTopology();
    }

    function updateButtonState() { 
        const synthBtn = document.getElementById('btn-synth');
        if(selectedNode) {
            mainBtn.className = "ui-element mode-edit";
            synthBtn.classList.add('active');
        } else {
            mainBtn.className = "ui-element mode-add";
            synthBtn.classList.remove('active');
        }
    }

    function deselectNode() { selectedNode = null; updateButtonState(); updateTopology(); }

    function updateTopology() {
        nodes.forEach(n => {
            const c = links.filter(l => (l.source.id||l.source)===n.id || (l.target.id||l.target)===n.id).length;
            n.radius = (35 + c * 4);
        });

        const link = linkGroup.selectAll("line").data(links, d => (d.source.id||d.source)+"-"+(d.target.id||d.target));
        link.exit().remove(); link.enter().append("line").attr("class", "link").merge(link);

        const node = nodeGroup.selectAll("g").data(nodes, d => d.id);
        node.exit().transition().duration(300).style("opacity", 0).remove();
        const nodeEnter = node.enter().append("g")
            .call(d3.drag().on("start", dragStart).on("drag", dragged).on("end", dragEnd))
            .on("click", handleNodeClick);

        nodeEnter.append("circle").attr("class", "hitbox");
        nodeEnter.append("circle").attr("class", "neuron-aura");
        nodeEnter.append("circle").attr("class", "neuron-core");
        nodeEnter.append("text").attr("class", "label").attr("dy", 0);

        const allNodes = nodeEnter.merge(node);
        allNodes.attr("class", d => `node-group ${d===selectedNode ? 'selected' : ''} ${d.isAI ? 'ai-generated' : ''}`);
        allNodes.select("text").text(d => d.label);
        
        allNodes.select(".neuron-core").transition().duration(300).attr("r", d => d.radius * 0.3);
        allNodes.select(".neuron-aura").transition().duration(300).attr("r", d => d.radius);
        allNodes.select(".hitbox").attr("r", d => d.radius + 10);
        allNodes.select("text.label").transition().duration(300).attr("dy", d => d.radius + 15);

        simulation.nodes(nodes).on("tick", () => {
            linkGroup.selectAll("line").attr("x1", d => d.source.x).attr("y1", d => d.source.y).attr("x2", d => d.target.x).attr("y2", d => d.target.y);
            allNodes.attr("transform", d => `translate(${d.x},${d.y})`);
        });
        simulation.force("link").links(links);
        simulation.alpha(0.5).restart();
    }

    function animateImpulse(source, target) {
        const impulse = impulseGroup.append("circle").attr("class", "impulse").attr("r", 3).attr("cx", source.x).attr("cy", source.y).attr("fill", "#fff");
        impulse.transition().duration(400).ease(d3.easeLinear).attr("cx", target.x).attr("cy", target.y).on("end", function() { d3.select(this).remove(); });
    }
    
    function animateVisuals() {
        d3.selectAll(".node-group").each(function(d) {
            if(!d.phase) d.phase = Math.random()*100; d.phase+=0.05;
            d3.select(this).select(".neuron-aura").attr("transform", `scale(${1+Math.sin(d.phase)*0.03})`);
        });
        requestAnimationFrame(animateVisuals);
    }
    animateVisuals();

    function dragStart(e, d) { if (!e.active) simulation.alphaTarget(0.3).restart(); d.fx = d.x; d.fy = d.y; }
    function dragged(e, d) { d.fx = e.x; d.fy = e.y; }
    function dragEnd(e, d) { if (!e.active) simulation.alphaTarget(0); d.fx = null; d.fy = null; saveData(); }

    function showMsg(txt) {
        const el = document.getElementById('alert-msg'); el.innerText = txt; el.style.opacity = 1;
        setTimeout(() => el.style.opacity = 0, 2000);
    }
    
    const renameModal = document.getElementById('rename-modal'), input = document.getElementById('rename-input');
    
    function openRename() {
        if(!selectedNode) return;
        renameModal.style.display = 'flex';
        if (selectedNode.label === "Void" || selectedNode.label === "") {
            input.value = ""; input.placeholder = "INPUT DATA...";
        } else {
            input.value = selectedNode.label;
        }
        setTimeout(() => { input.focus(); if(input.value.length > 0) input.select(); }, 50);
    }
    
    function saveRename() { 
        if(selectedNode) { 
            selectedNode.label = input.value.trim() || selectedNode.label; 
            updateTopology(); saveData(); 
        } 
        renameModal.style.display='none'; 
    }
    input.addEventListener("keypress", (e) => { if(e.key === "Enter") saveRename(); });

    function clearData() { 
        document.getElementById('confirm-modal').style.display = 'flex';
    }
    
    function confirmWipe(shouldWipe) {
        document.getElementById('confirm-modal').style.display = 'none';
        if(shouldWipe) {
            localStorage.removeItem('inaihr_v2_janus');
            location.reload();
        }
    }

    function saveData() {
        const cl = nodes.map(n => ({ id:n.id, label:n.label, x:n.x, y:n.y, isAI:n.isAI }));
        const ln = links.map(l => ({ source:l.source.id||l.source, target:l.target.id||l.target }));
        localStorage.setItem('inaihr_v2_janus', JSON.stringify({ nodes:cl, links:ln }));
    }

    updateButtonState(); updateTopology();
</script>
</body>
</html>
